<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD SMC Sniper (v10.0 - Volatility Fix)</title>
    <style>
        /* ================= DARK THEME ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #050505; min-height: 100vh; color: #cfcfcf; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: rgba(20, 20, 25, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 16px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .header h1 { font-size: 1.5rem; color: #ffd700; font-weight: 800; letter-spacing: -0.5px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .status-open { background: rgba(0, 255, 136, 0.15); color: #00ff88; border: 1px solid rgba(0, 255, 136, 0.2); }
        .status-closed { background: rgba(255, 71, 87, 0.15); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.2); }
        .pulse { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* GRID LAYOUT */
        .main-grid { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        /* UPLOAD ZONE */
        .upload-card { background: #111; border-radius: 16px; padding: 20px; border: 1px solid #222; height: 100%; display: flex; flex-direction: column; }
        .drop-zone { border: 2px dashed #333; border-radius: 12px; flex: 1; min-height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.01); position: relative; overflow: hidden; }
        .drop-zone:hover { border-color: #ffd700; background: rgba(255, 215, 0, 0.02); }
        .preview-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        .preview-img.show { display: block; }
        .placeholder { text-align: center; color: #555; pointer-events: none; }
        .placeholder.hide { display: none; }
        
        /* CONTROLS */
        .controls-card { background: #111; border-radius: 16px; padding: 25px; border: 1px solid #222; }
        .input-group { margin-bottom: 15px; }
        .label { display: block; font-size: 0.7rem; color: #666; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
        .input-field { width: 100%; background: #0a0a0a; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; outline: none; font-size: 0.9rem; transition: 0.2s; }
        .input-field:focus { border-color: #ffd700; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .analyze-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #ffd700, #ff9900); border: none; border-radius: 8px; color: #000; font-weight: 900; font-size: 1rem; cursor: pointer; margin-top: 10px; transition: 0.2s; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.15); }
        .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(255, 215, 0, 0.25); }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* RESULTS */
        .result-box { margin-top: 20px; display: none; animation: slideUp 0.4s ease-out; }
        .result-box.show { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .signal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #222; }
        .bias { font-size: 2rem; font-weight: 900; }
        .bias.BUY { color: #00ff88; text-shadow: 0 0 20px rgba(0,255,136,0.2); }
        .bias.SELL { color: #ff4757; text-shadow: 0 0 20px rgba(255,71,87,0.2); }
        .bias.WAIT { color: #888; }
        
        .type-badge { background: #222; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; color: #aaa; border: 1px solid #333; }
        
        .levels-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .level-card { background: #161616; padding: 15px 10px; border-radius: 10px; text-align: center; border: 1px solid #252525; }
        .level-title { font-size: 0.7rem; color: #666; margin-bottom: 5px; font-weight: 700; }
        .level-price { font-size: 1.1rem; font-weight: 700; color: #fff; }
        .level-card.entry { border-color: rgba(100,149,237,0.3); } .level-card.entry .level-price { color: #6495ed; }
        .level-card.sl { border-color: rgba(255,71,87,0.3); } .level-card.sl .level-price { color: #ff4757; }
        .level-card.tp { border-color: rgba(0,255,136,0.3); } .level-card.tp .level-price { color: #00ff88; }
        
        .pips-diff { font-size: 0.7rem; opacity: 0.6; margin-top: 5px; }

        .reason-text { font-size: 0.9rem; line-height: 1.6; color: #bbb; background: #161616; padding: 15px; border-radius: 10px; border-left: 3px solid #444; }

        .loading { display: none; text-align: center; padding: 40px; }
        .spinner { width: 30px; height: 30px; border: 3px solid rgba(255,215,0,0.2); border-top-color: #ffd700; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>ðŸ¥‡ XAU/USD SMC SNIPER v10</h1>
        <div class="status-badge status-open" id="statusBadge">
            <span class="pulse"></span> <span id="statusText">MARKET OPEN</span>
        </div>
    </header>

    <div class="main-grid">
        <div class="upload-card">
            <div class="drop-zone" id="dropZone">
                <div class="placeholder" id="dropText">
                    <div style="font-size: 3rem; margin-bottom: 15px;">ðŸ“¸</div>
                    <div style="font-weight: 700;">Upload 15m Chart</div>
                    <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 5px;">Paste (Ctrl+V) or Drag Image</div>
                </div>
                <img id="preview" class="preview-img">
            </div>
            <button onclick="clearImage()" style="background:none; border:none; color:#ff4757; cursor:pointer; margin-top:10px; font-size:0.8rem; display:none;" id="clearBtn">Remove Image</button>
        </div>

        <div class="controls-card">
            
            <div class="input-group">
                <label class="label" style="color:#00ff88;">AI Model ID</label>
                <input type="text" id="modelId" class="input-field" value="google/gemini-2.0-flash-exp:free" placeholder="e.g. google/gemini-flash-1.5-8b">
            </div>

            <div class="row">
                <div class="input-group">
                    <label class="label">Current Price (Exact)</label>
                    <input type="number" id="price" class="input-field" placeholder="2650.00" step="0.01">
                </div>
                <div class="input-group">
                    <label class="label">Strategy</label>
                    <select id="strategy" class="input-field">
                        <option value="scalping">âš¡ SMC Scalping (15m)</option>
                        <option value="intraday">ðŸ“Š Intraday (1H)</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label class="label">OpenRouter API Key</label>
                <input type="password" id="key" class="input-field" placeholder="sk-or-...">
            </div>

            <button class="analyze-btn" id="btn" onclick="analyze()">ANALYZE STRUCTURE</button>

            <div class="loading" id="loader">
                <div class="spinner"></div>
                <div style="font-size:0.8rem; color:#ffd700;">Applying Volatility Filter...</div>
            </div>

            <div class="result-box" id="result">
                <div class="signal-header">
                    <div>
                        <div style="font-size:0.7rem; color:#666; font-weight:700;">BIAS</div>
                        <div class="bias" id="resBias">--</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="type-badge" id="resType">--</div>
                        <div style="font-size:0.7rem; color:#666; margin-top:4px;">Conf: <span id="resConf">--</span></div>
                    </div>
                </div>

                <div class="levels-grid">
                    <div class="level-card entry">
                        <div class="level-title">ENTRY</div>
                        <div class="level-price" id="resEntry">--</div>
                    </div>
                    <div class="level-card sl">
                        <div class="level-title">STOP LOSS</div>
                        <div class="level-price" id="resSL">--</div>
                        <div class="pips-diff" id="slDist">--</div>
                    </div>
                    <div class="level-card tp">
                        <div class="level-title">TAKE PROFIT</div>
                        <div class="level-price" id="resTP">--</div>
                        <div class="pips-diff" id="tpDist">--</div>
                    </div>
                </div>

                <div class="reason-text" id="resReason">--</div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- MARKET HOURS ---
    function checkMarket() {
        const d = new Date();
        const day = d.getUTCDay(), h = d.getUTCHours();
        const closed = (day===6) || (day===0 && h<22) || (day===5 && h>=22);
        const el = document.getElementById('statusBadge');
        const txt = document.getElementById('statusText');
        
        if(closed) {
            el.className = 'status-badge status-closed';
            txt.innerText = 'MARKET CLOSED';
        } else {
            el.className = 'status-badge status-open';
            txt.innerText = 'MARKET OPEN';
        }
    }
    setInterval(checkMarket, 60000); checkMarket();

    // --- IMAGE HANDLING ---
    let imgBase64 = null;
    const dropZone = document.getElementById('dropZone');
    const fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='image/*';
    
    dropZone.onclick = () => { if(!imgBase64) fileIn.click(); };
    fileIn.onchange = e => loadFile(e.target.files[0]);
    document.onpaste = e => { if(e.clipboardData.items[0].type.includes('image')) loadFile(e.clipboardData.items[0].getAsFile()); };
    
    function loadFile(file) {
        const r = new FileReader();
        r.onload = e => {
            imgBase64 = e.target.result;
            document.getElementById('preview').src = imgBase64;
            document.getElementById('preview').classList.add('show');
            document.getElementById('dropText').classList.add('hide');
            document.getElementById('clearBtn').style.display = 'inline-block';
        };
        r.readAsDataURL(file);
    }

    function clearImage() {
        imgBase64 = null;
        document.getElementById('preview').classList.remove('show');
        document.getElementById('dropText').classList.remove('hide');
        document.getElementById('clearBtn').style.display = 'none';
        document.getElementById('result').classList.remove('show');
    }

    // --- ANALYSIS ENGINE ---
    const savedKey = localStorage.getItem('or_key');
    if(savedKey) document.getElementById('key').value = savedKey;

    async function analyze() {
        const key = document.getElementById('key').value.trim();
        const model = document.getElementById('modelId').value.trim();
        const price = document.getElementById('price').value;
        const strategy = document.getElementById('strategy').value;

        if(!key || !model || !imgBase64) return alert("âš ï¸ Missing Key, Model ID, or Chart Image");

        localStorage.setItem('or_key', key);
        
        // UI LOADING STATE
        document.getElementById('btn').disabled = true;
        document.getElementById('loader').style.display = 'block';
        document.getElementById('result').classList.remove('show');

        // FORCE AI TO USE WIDER LEVELS (VOLATILITY GUARD)
        // We tell the AI: "A Gold Scalp SL must be at least $2.00 away."
        const systemPrompt = `
        You are an elite Institutional Gold Trader.
        
        INPUTS:
        - Current Market Price: ${price ? price : "Read from Chart Axis"}
        - Strategy: ${strategy.toUpperCase()}
        
        CRITICAL RULES FOR GOLD (XAU/USD):
        1. SPREAD PROTECTION: Gold has spread. 
           - STOP LOSS must be AT LEAST $2.00 (20 pips) away from Entry.
           - TAKE PROFIT must be AT LEAST $3.00 (30 pips) away from Entry.
           - DO NOT provide tight ranges like $0.30 or $0.50. They are impossible to trade.
        
        2. LOGIC:
           - Identify Trend & Key Levels (Order Blocks/FVG).
           - IF Price is >$2.00 away from key level -> SIGNAL: LIMIT.
           - IF Price is <$2.00 from key level -> SIGNAL: MARKET.
           
        3. OUTPUT JSON:
        {
            "bias": "BUY" | "SELL" | "WAIT",
            "type": "MARKET" | "LIMIT" | "WAITING",
            "confidence": 0-100,
            "entry": number,
            "sl": number,
            "tp": number,
            "reason": "Technical reason using SMC concepts."
        }
        `;

        try {
            const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": window.location.href
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: systemPrompt },
                            { type: "image_url", image_url: { url: imgBase64 } }
                        ]
                    }],
                    response_format: { type: "json_object" }
                })
            });

            if(!resp.ok) throw new Error("API Error: " + resp.status);
            
            const data = await resp.json();
            const content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            const res = JSON.parse(content);

            // RENDER RESULTS
            const biasEl = document.getElementById('resBias');
            biasEl.innerText = res.bias;
            biasEl.className = 'bias ' + res.bias;

            document.getElementById('resType').innerText = res.type;
            document.getElementById('resConf').innerText = res.confidence + '%';
            document.getElementById('resEntry').innerText = res.entry || price;
            document.getElementById('resSL').innerText = res.sl || '--';
            document.getElementById('resTP').innerText = res.tp || '--';
            document.getElementById('resReason').innerText = res.reason;

            // Show Pips Distance
            if(res.entry && res.sl) {
                const diff = Math.abs(res.entry - res.sl).toFixed(2);
                document.getElementById('slDist').innerText = diff + " USD range";
                document.getElementById('slDist').style.color = diff < 1.5 ? 'red' : '#666'; // Warn if too tight
            }
             if(res.entry && res.tp) {
                const diff = Math.abs(res.entry - res.tp).toFixed(2);
                document.getElementById('tpDist').innerText = diff + " USD range";
            }

            document.getElementById('result').classList.add('show');

        } catch (e) {
            alert("âŒ Analysis Failed: " + e.message);
        }

        document.getElementById('btn').disabled = false;
        document.getElementById('loader').style.display = 'none';
    }
</script>

</body>
</html>
