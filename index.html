<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD Precision AI Analyst</title>
    <style>
        /* CSS REMAINS THE SAME - OPTIMIZED FOR DARK MODE */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0b0e14; min-height: 100vh; color: #e1e1e1; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #151921; border-radius: 12px; border: 1px solid #2a2e39; margin-bottom: 20px; }
        .header h1 { color: #d4af37; font-size: 1.5rem; letter-spacing: 1px; }
        .live-tag { background: rgba(0, 255, 136, 0.1); color: #00ff88; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; border: 1px solid rgba(0, 255, 136, 0.2); }

        /* GRID SYSTEM */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        /* UPLOAD CARD */
        .card { background: #151921; border-radius: 16px; border: 1px solid #2a2e39; padding: 25px; }
        .card-title { color: #fff; margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        .drop-zone { border: 2px dashed #3a3f4b; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; background: #1a1e28; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .drop-zone:hover { border-color: #d4af37; background: #1f2430; }
        .drop-zone.has-image { padding: 10px; border: 2px solid #d4af37; }
        
        .preview-img { max-width: 100%; max-height: 400px; border-radius: 8px; display: none; }
        .drop-text { color: #888; margin-top: 15px; }

        /* SETTINGS & API */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .styled-input { width: 100%; background: #0b0e14; border: 1px solid #3a3f4b; color: #fff; padding: 10px; border-radius: 8px; outline: none; }
        .styled-input:focus { border-color: #667eea; }

        .analyze-btn { width: 100%; background: linear-gradient(135deg, #d4af37, #f3cf55); border: none; padding: 15px; border-radius: 10px; color: #000; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2); }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* RESULTS */
        .result-container { display: none; margin-top: 0; }
        .result-container.show { display: block; }
        
        .signal-header { text-align: center; background: #1a1e28; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #2a2e39; }
        .bias-text { font-size: 2.5rem; font-weight: 800; margin: 10px 0; }
        .bias-buy { color: #00ff88; text-shadow: 0 0 20px rgba(0, 255, 136, 0.2); }
        .bias-sell { color: #ff4757; text-shadow: 0 0 20px rgba(255, 71, 87, 0.2); }
        .bias-neutral { color: #a4a4a4; }
        .bias-wait { color: #d4af37; }

        .levels-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .level-box { background: #1a1e28; padding: 15px 10px; border-radius: 10px; text-align: center; border: 1px solid #2a2e39; }
        .level-title { font-size: 0.7rem; color: #888; letter-spacing: 1px; margin-bottom: 5px; }
        .level-price { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .entry-box { border-color: rgba(102, 126, 234, 0.5); }
        .entry-box .level-price { color: #a78bfa; }

        .analysis-text { background: #1a1e28; padding: 20px; border-radius: 12px; font-size: 0.9rem; line-height: 1.6; color: #ccc; border-left: 4px solid #d4af37; white-space: pre-wrap; }

        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.3); border-radius: 50%; border-top-color: #000; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>ü•á XAU/USD Precision AI</h1>
        <span class="live-tag">READY</span>
    </header>

    <div class="main-grid">
        <div class="card">
            <h2 class="card-title">üì∏ Chart Upload</h2>
            
            <div class="drop-zone" id="dropZone">
                <div id="dropContent">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üìä</div>
                    <div>Click or Paste (Ctrl+V) Chart</div>
                    <div class="drop-text">Supported: TradingView Screenshots</div>
                </div>
                <img id="previewImg" class="preview-img">
            </div>
            <input type="file" id="fileInput" hidden accept="image/*">

            <div style="margin-top: 20px;">
                <div class="settings-grid">
                    <div class="input-group">
                        <label>Strategy Mode</label>
                        <select id="strategy" class="styled-input">
                            <option value="sniper">üéØ Sniper Entry (Retests)</option>
                            <option value="scalp">‚ö° Scalping (Current Price)</option>
                            <option value="swing">üåä Swing (Major Levels)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Timeframe</label>
                        <select id="timeframe" class="styled-input">
                            <option value="5m">5 Minute</option>
                            <option value="15m" selected>15 Minute</option>
                            <option value="1h">1 Hour</option>
                            <option value="4h">4 Hour</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>OpenRouter API Key (Free)</label>
                    <input type="password" id="apiKey" class="styled-input" placeholder="sk-or-...">
                </div>

                <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()">
                    üîç Analyze Structure & Find Entry
                </button>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">ü§ñ AI Trade Plan</h2>
            
            <div id="placeholder" style="text-align: center; color: #555; padding: 50px;">
                Waiting for analysis...<br>
                Upload chart to begin.
            </div>

            <div id="result" class="result-container">
                <div class="signal-header">
                    <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">BIAS / DIRECTION</div>
                    <div id="biasOut" class="bias-text">--</div>
                    <div id="reasonOut" style="font-size: 0.85rem; color: #ccc;">--</div>
                </div>

                <div class="levels-row">
                    <div class="level-box entry-box">
                        <div class="level-title">IDEAL ENTRY</div>
                        <div id="entryOut" class="level-price">--</div>
                    </div>
                    <div class="level-box" style="border-color: rgba(255, 71, 87, 0.3);">
                        <div class="level-title">STOP LOSS</div>
                        <div id="slOut" class="level-price">--</div>
                    </div>
                    <div class="level-box" style="border-color: rgba(0, 255, 136, 0.3);">
                        <div class="level-title">TAKE PROFIT</div>
                        <div id="tpOut" class="level-price">--</div>
                    </div>
                </div>

                <div class="analysis-text" id="analysisOut"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. IMAGE HANDLING
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const dropContent = document.getElementById('dropContent');
    let currentImage = null;

    dropZone.addEventListener('click', () => fileInput.click());

    document.addEventListener('paste', (e) => {
        const file = e.clipboardData.files[0];
        if (file && file.type.startsWith('image/')) handleFile(file);
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImage = e.target.result;
            previewImg.src = currentImage;
            previewImg.style.display = 'block';
            dropContent.style.display = 'none';
            dropZone.classList.add('has-image');
        };
        reader.readAsDataURL(file);
    }

    // 2. LOAD SAVED KEY
    if(localStorage.getItem('or_key')) {
        document.getElementById('apiKey').value = localStorage.getItem('or_key');
    }

    // 3. ANALYSIS LOGIC
    async function runAnalysis() {
        const key = document.getElementById('apiKey').value;
        const strategy = document.getElementById('strategy').value;
        const timeframe = document.getElementById('timeframe').value;

        if (!currentImage || !key) {
            alert('Please upload an image and enter API Key');
            return;
        }

        localStorage.setItem('or_key', key);
        
        const btn = document.getElementById('analyzeBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<span class="spinner"></span> Analyzing Market Structure...`;
        btn.disabled = true;

        try {
            // STRICT PROMPT ENGINEERING
            const prompt = `
            You are a professional Gold (XAU/USD) Trader using Smart Money Concepts (SMC) and Price Action.
            
            STRICT INSTRUCTIONS FOR ACCURACY:
            1. DO NOT simply suggest buying/selling at the Current Market Price (CMP) unless there is a confirmed breakout.
            2. Generally, you should look for a "Limit Order" (Pullback to support for buys, Pullback to resistance for sells).
            3. If the price is in "No Man's Land" (middle of range), the Signal must be "WAIT".
            4. Identify the specific price of the Order Block or FVG (Fair Value Gap).
            
            STRATEGY: ${strategy.toUpperCase()}
            TIMEFRAME: ${timeframe.toUpperCase()}

            Analyze the image and return valid JSON (no markdown) in this exact format:
            {
                "bias": "BUY" | "SELL" | "WAIT",
                "reason": "Short summary (e.g., Retest of 2650 Support)",
                "current_price": 1234.56,
                "entry_price": 1234.56,
                "stop_loss": 1230.00,
                "take_profit": 1250.00,
                "analysis": "Full detailed technical analysis explaining the structure, trend, and why this specific entry level was chosen."
            }
            `;

            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    // Using Gemini 2.0 Flash - Best generic free vision model
                    model: "google/gemini-2.0-flash-exp:free", 
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: prompt },
                                { type: "image_url", image_url: { url: currentImage } }
                            ]
                        }
                    ],
                    // Temperature 0 = Strict, Reproducible results (fixes "same chart difference")
                    temperature: 0, 
                    response_format: { type: "json_object" }
                })
            });

            const data = await response.json();
            
            if(data.error) throw new Error(data.error.message);
            
            const content = data.choices[0].message.content;
            // Clean markdown if model adds it by mistake
            const cleanJson = content.replace(/```json/g, '').replace(/```/g, '');
            const result = JSON.parse(cleanJson);

            renderResult(result);

        } catch (error) {
            alert("Error: " + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function renderResult(data) {
        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('result').classList.add('show');

        // Bias Styling
        const biasEl = document.getElementById('biasOut');
        biasEl.textContent = data.bias;
        biasEl.className = 'bias-text'; // reset
        if(data.bias.includes('BUY')) biasEl.classList.add('bias-buy');
        else if(data.bias.includes('SELL')) biasEl.classList.add('bias-sell');
        else biasEl.classList.add('bias-wait');

        document.getElementById('reasonOut').textContent = data.reason;
        
        // Levels
        const formatPrice = (p) => p ? parseFloat(p).toFixed(2) : '--';
        document.getElementById('entryOut').textContent = formatPrice(data.entry_price);
        document.getElementById('slOut').textContent = formatPrice(data.stop_loss);
        document.getElementById('tpOut').textContent = formatPrice(data.take_profit);

        // Calculate Pips/R:R to display in analysis
        let extraInfo = '';
        if(data.entry_price && data.stop_loss && data.bias !== 'WAIT') {
            const risk = Math.abs(data.entry_price - data.stop_loss);
            extraInfo = `\n\nRisk Distance: $${risk.toFixed(2)}`;
        }

        document.getElementById('analysisOut').innerText = data.analysis + extraInfo;
    }
</script>

</body>
</html>
