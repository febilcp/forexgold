<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD AI Chart Vision Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a12;
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.15);
        }

        .header h1 {
            font-size: 1.4rem;
            color: #ffd700;
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(0, 255, 136, 0); }
        }

        /* Sessions */
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .session-card {
            background: linear-gradient(145deg, #151520, #1a1a28);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .session-card.active {
            border-color: rgba(0, 255, 136, 0.4);
        }

        .session-card.active::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: #00ff88;
            border-radius: 10px 10px 0 0;
        }

        .session-icon { font-size: 1.2rem; }
        .session-name { font-size: 0.8rem; font-weight: 600; margin: 4px 0; }
        .session-card:nth-child(1) .session-name { color: #ff6b9d; }
        .session-card:nth-child(2) .session-name { color: #4a9eff; }
        .session-card:nth-child(3) .session-name { color: #ffd700; }

        .session-status {
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        .session-status.active { background: rgba(0, 255, 136, 0.15); color: #00ff88; }
        .session-status.inactive { background: rgba(255, 255, 255, 0.1); color: #666; }

        .session-timer {
            font-size: 0.85rem;
            font-weight: bold;
            font-family: monospace;
            margin-top: 4px;
        }
        .session-card.active .session-timer { color: #00ff88; }
        .session-card.inactive .session-timer { color: #ffd700; }
        .timer-label { font-size: 0.55rem; color: #555; }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Upload Section */
        .upload-section {
            background: #12121a;
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.15);
            padding: 20px;
        }

        .upload-title {
            color: #ffd700;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 215, 0, 0.02);
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .drop-zone:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }

        .drop-zone.drag-over {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .drop-zone.has-image { padding: 10px; }
        .drop-icon { font-size: 3rem; margin-bottom: 15px; }
        .drop-text { color: #888; font-size: 0.95rem; margin-bottom: 10px; }
        .drop-subtext { color: #555; font-size: 0.75rem; }
        .file-input { display: none; }

        /* Preview */
        .preview-container { width: 100%; display: none; }
        .preview-container.show { display: block; }

        .preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        .preview-btn {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
        }

        .preview-btn.remove {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        /* Paste Info */
        .paste-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            text-align: center;
        }

        .paste-info-text { color: #a78bfa; font-size: 0.8rem; }

        .paste-shortcut {
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 10px;
            border-radius: 4px;
            font-family: monospace;
            color: #fff;
        }

        /* AI Section */
        .ai-section {
            background: #12121a;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            display: flex;
            flex-direction: column;
        }

        .ai-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.1));
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .ai-header h2 {
            color: #a78bfa;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        /* Settings */
        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .setting-item label {
            display: block;
            font-size: 0.65rem;
            color: #666;
            margin-bottom: 4px;
        }

        .setting-select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 0.8rem;
        }

        /* API Input */
        .api-section { margin-bottom: 12px; }

        .api-input {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .api-link {
            color: #667eea;
            font-size: 0.7rem;
            text-decoration: none;
        }

        .api-note {
            color: #00ff88;
            font-size: 0.65rem;
            margin-top: 5px;
        }

        /* Button */
        .ai-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .ai-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 25px rgba(102, 126, 234, 0.4);
        }

        .ai-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* AI Content */
        .ai-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
        }

        .ai-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #555;
        }

        .ai-placeholder-icon { font-size: 3rem; margin-bottom: 15px; }
        .ai-placeholder-text { font-size: 0.9rem; color: #666; line-height: 1.6; }

        /* Result */
        .ai-result { display: none; }
        .ai-result.show { display: block; }

        .signal-box {
            text-align: center;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .signal-badges {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .badge.gold { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
        .badge.purple { background: rgba(102, 126, 234, 0.2); color: #a78bfa; }
        .badge.green { background: rgba(0, 255, 136, 0.2); color: #00ff88; }

        .signal-bias {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .signal-bias.strong-buy { color: #00ff88; }
        .signal-bias.buy { color: #7dffb3; }
        .signal-bias.neutral-buy { color: #b8ffda; }
        .signal-bias.neutral { color: #ffd700; }
        .signal-bias.neutral-sell { color: #ffb3b3; }
        .signal-bias.sell { color: #ff7a7a; }
        .signal-bias.strong-sell { color: #ff4757; }

        .confidence-row { margin-top: 10px; }
        .confidence-label { font-size: 0.75rem; color: #888; margin-bottom: 5px; }

        .confidence-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill { height: 100%; border-radius: 4px; }
        .confidence-fill.high { background: linear-gradient(90deg, #00ff88, #00cc6a); }
        .confidence-fill.medium { background: linear-gradient(90deg, #ffd700, #ffaa00); }
        .confidence-fill.low { background: linear-gradient(90deg, #ff4757, #ff6b7a); }

        /* Levels */
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .level-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
        }

        .level-card.entry { border: 1px solid rgba(102, 126, 234, 0.4); }
        .level-card.sl { border: 1px solid rgba(255, 71, 87, 0.4); }
        .level-card.tp { border: 1px solid rgba(0, 255, 136, 0.4); }

        .level-label { font-size: 0.65rem; color: #666; margin-bottom: 5px; }
        .level-value { font-size: 1.2rem; font-weight: bold; }

        .level-card.entry .level-value { color: #a78bfa; }
        .level-card.sl .level-value { color: #ff4757; }
        .level-card.tp .level-value { color: #00ff88; }

        .level-pips { font-size: 0.6rem; color: #555; margin-top: 3px; }

        /* Analysis */
        .analysis-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            border-left: 3px solid #667eea;
        }

        .analysis-title { color: #a78bfa; font-size: 0.8rem; margin-bottom: 10px; font-weight: 600; }
        .analysis-text { color: #ccc; font-size: 0.85rem; line-height: 1.7; white-space: pre-wrap; }

        .timestamp { text-align: center; font-size: 0.65rem; color: #444; margin-top: 15px; }

        /* Error */
        .error-box {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            text-align: center;
            display: none;
        }

        .error-box.show { display: block; }
        .error-box p { color: #ff6b7a; font-size: 0.85rem; }

        /* Responsive */
        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .sessions-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">

        <!-- Header -->
        <header class="header">
            <h1>ü•á XAU/USD AI Vision</h1>
            <div class="live-badge">
                <span class="live-dot"></span>
                <span style="color: #00ff88; font-size: 0.85rem;">LIVE</span>
            </div>
        </header>

        <!-- Sessions -->
        <div class="sessions-grid">
            <div class="session-card" id="tokyoCard">
                <div class="session-icon">üóº</div>
                <div class="session-name">Tokyo</div>
                <div class="session-status" id="tokyoStatus">--</div>
                <div class="session-timer" id="tokyoTimer">--</div>
                <div class="timer-label" id="tokyoLabel">--</div>
            </div>
            <div class="session-card" id="londonCard">
                <div class="session-icon">üè∞</div>
                <div class="session-name">London</div>
                <div class="session-status" id="londonStatus">--</div>
                <div class="session-timer" id="londonTimer">--</div>
                <div class="timer-label" id="londonLabel">--</div>
            </div>
            <div class="session-card" id="newyorkCard">
                <div class="session-icon">üóΩ</div>
                <div class="session-name">New York</div>
                <div class="session-status" id="newyorkStatus">--</div>
                <div class="session-timer" id="newyorkTimer">--</div>
                <div class="timer-label" id="newyorkLabel">--</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">

            <!-- Upload Section -->
            <div class="upload-section">
                <h2 class="upload-title">üì∏ Upload Chart Screenshot</h2>
                
                <div class="drop-zone" id="dropZone">
                    <div id="dropContent">
                        <div class="drop-icon">üìä</div>
                        <div class="drop-text">Drop chart image or click to upload</div>
                        <div class="drop-subtext">PNG, JPG, JPEG, WebP</div>
                    </div>
                    <div class="preview-container" id="previewContainer">
                        <img class="preview-image" id="previewImage" alt="Chart">
                        <div class="preview-actions">
                            <button class="preview-btn remove" onclick="removeImage()">üóëÔ∏è Remove</button>
                        </div>
                    </div>
                </div>
                <input type="file" class="file-input" id="fileInput" accept="image/*">

                <div class="paste-info">
                    <div class="paste-info-text">
                        üí° Press <span class="paste-shortcut">Ctrl+V</span> to paste screenshot!
                    </div>
                </div>
            </div>

            <!-- AI Section -->
            <div class="ai-section">
                <div class="ai-header">
                    <h2>ü§ñ AI Vision Analysis</h2>

                    <div class="settings-row">
                        <div class="setting-item">
                            <label>Strategy</label>
                            <select class="setting-select" id="strategySelect">
                                <option value="scalping">‚ö° Scalping</option>
                                <option value="intraday" selected>üìä Intraday</option>
                                <option value="swing">üìà Swing</option>
                                <option value="smc">üéØ SMC/ICT</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Timeframe</label>
                            <select class="setting-select" id="timeframeSelect">
                                <option value="1m">1M</option>
                                <option value="5m">5M</option>
                                <option value="15m" selected>15M</option>
                                <option value="30m">30M</option>
                                <option value="1h">1H</option>
                                <option value="4h">4H</option>
                                <option value="1d">1D</option>
                            </select>
                        </div>
                    </div>

                    <div class="api-section">
                        <input type="password" class="api-input" id="apiInput" placeholder="üîë OpenRouter API Key">
                        <a href="https://openrouter.ai/keys" target="_blank" class="api-link">Get FREE OpenRouter API Key ‚Üí</a>
                        <div class="api-note">‚úÖ OpenRouter has FREE vision models!</div>
                    </div>

                    <button class="ai-button" id="analyzeBtn" onclick="analyzeChart()">
                        üîç Analyze Chart
                    </button>

                    <div class="error-box" id="errorBox">
                        <p id="errorText"></p>
                    </div>
                </div>

                <div class="ai-content">
                    <div class="ai-placeholder" id="placeholder">
                        <div class="ai-placeholder-icon">üëÅÔ∏è</div>
                        <div class="ai-placeholder-text">
                            1. Screenshot your chart<br>
                            2. Upload or Ctrl+V paste<br>
                            3. AI sees all indicators!
                        </div>
                    </div>

                    <div class="ai-result" id="result">
                        <div class="signal-box">
                            <div class="signal-badges">
                                <span class="badge gold">XAUUSD</span>
                                <span class="badge purple" id="badgeStrategy">INTRADAY</span>
                                <span class="badge green" id="badgeTF">15M</span>
                            </div>
                            <div class="signal-bias" id="resultBias">--</div>
                            <div class="confidence-row">
                                <div class="confidence-label">Confidence: <span id="confidenceValue">--</span></div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" id="confidenceFill" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="levels-grid">
                            <div class="level-card entry">
                                <div class="level-label">ENTRY</div>
                                <div class="level-value" id="resultEntry">--</div>
                                <div class="level-pips" id="entryPips">--</div>
                            </div>
                            <div class="level-card sl">
                                <div class="level-label">STOP LOSS</div>
                                <div class="level-value" id="resultSL">--</div>
                                <div class="level-pips" id="slPips">--</div>
                            </div>
                            <div class="level-card tp">
                                <div class="level-label">TAKE PROFIT</div>
                                <div class="level-value" id="resultTP">--</div>
                                <div class="level-pips" id="tpPips">--</div>
                            </div>
                        </div>

                        <div class="analysis-box">
                            <div class="analysis-title">üìù Chart Analysis</div>
                            <div class="analysis-text" id="resultAnalysis">--</div>
                        </div>

                        <div class="timestamp" id="resultTime">--</div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // ============================================
        // SESSIONS
        // ============================================
        
        const sessions = {
            tokyo: { start: 0, end: 9 },
            london: { start: 7, end: 16 },
            newyork: { start: 12, end: 21 }
        };

        function updateSessions() {
            const now = new Date();
            const h = now.getUTCHours();
            const m = now.getUTCMinutes();
            const s = now.getUTCSeconds();

            Object.keys(sessions).forEach(key => {
                const ses = sessions[key];
                const card = document.getElementById(key + 'Card');
                const status = document.getElementById(key + 'Status');
                const timer = document.getElementById(key + 'Timer');
                const label = document.getElementById(key + 'Label');

                const active = h >= ses.start && h < ses.end;
                
                card.classList.toggle('active', active);
                status.className = 'session-status ' + (active ? 'active' : 'inactive');
                status.textContent = active ? '‚óè Active' : '‚óã Closed';

                if (active) {
                    timer.textContent = `${ses.end - h - 1}h ${59-m}m ${59-s}s`;
                    label.textContent = 'Closes in';
                } else {
                    let hrs = ses.start - h;
                    if (hrs < 0) hrs += 24;
                    timer.textContent = `${hrs}h ${59-m}m ${59-s}s`;
                    label.textContent = 'Opens in';
                }
            });
        }

        setInterval(updateSessions, 1000);
        updateSessions();

        // ============================================
        // IMAGE HANDLING
        // ============================================
        
        let uploadedImage = null;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const dropContent = document.getElementById('dropContent');

        dropZone.addEventListener('click', () => {
            if (!uploadedImage) fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files?.[0]) handleFile(e.target.files[0]);
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files?.[0]) handleFile(e.dataTransfer.files[0]);
        });

        document.addEventListener('paste', (e) => {
            for (let item of e.clipboardData.items) {
                if (item.type.includes('image')) {
                    handleFile(item.getAsFile());
                    break;
                }
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = e.target.result;
                previewImage.src = uploadedImage;
                dropContent.style.display = 'none';
                previewContainer.classList.add('show');
                dropZone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImage = null;
            previewImage.src = '';
            dropContent.style.display = 'flex';
            previewContainer.classList.remove('show');
            dropZone.classList.remove('has-image');
            fileInput.value = '';
        }

        // ============================================
        // LOAD SAVED KEY
        // ============================================
        
        const savedKey = localStorage.getItem('openrouter_vision_key');
        if (savedKey) document.getElementById('apiInput').value = savedKey;

        // ============================================
        // VISION MODELS (OpenRouter)
        // ============================================
        
        const VISION_MODELS = [
            'qwen/qwen-2-vl-7b-instruct:free',
            'meta-llama/llama-3.2-11b-vision-instruct:free',
            'google/gemini-2.0-flash-exp:free',
            'google/gemini-flash-1.5',
            'anthropic/claude-3-haiku'
        ];

        // ============================================
        // ANALYZE
        // ============================================
        
        async function analyzeChart() {
            const apiKey = document.getElementById('apiInput').value.trim();
            const strategy = document.getElementById('strategySelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;

            if (!uploadedImage) {
                showError('‚ö†Ô∏è Upload a chart screenshot first');
                return;
            }

            if (!apiKey) {
                showError('‚ö†Ô∏è Enter OpenRouter API key from openrouter.ai/keys');
                return;
            }

            localStorage.setItem('openrouter_vision_key', apiKey);
            hideError();

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;

            let success = false;
            let lastError = '';

            for (const model of VISION_MODELS) {
                if (success) break;
                
                try {
                    console.log('Trying model:', model);
                    btn.innerHTML = `<div class="spinner"></div> ${model.split('/')[1].split(':')[0]}...`;
                    
                    const result = await callOpenRouter(apiKey, model, strategy, timeframe);
                    displayResult(result, strategy, timeframe);
                    success = true;
                    console.log('Success with:', model);
                } catch (err) {
                    console.log(`${model} failed:`, err.message);
                    lastError = err.message;
                }
            }

            if (!success) {
                showError('‚ùå ' + lastError);
            }

            btn.disabled = false;
            btn.innerHTML = 'üîç Analyze Chart';
        }

        // ============================================
        // OPENROUTER API
        // ============================================
        
        async function callOpenRouter(apiKey, model, strategy, timeframe) {
            const h = new Date().getUTCHours();
            let session = 'Asian Session';
            if (h >= 7 && h < 16) session = 'London Session';
            if (h >= 12 && h < 21) session = 'New York Session';
            if (h >= 12 && h < 16) session = 'London-NY Overlap';

            const configs = {
                scalping: { sl: '10-20', tp: '15-30' },
                intraday: { sl: '20-35', tp: '40-70' },
                swing: { sl: '40-70', tp: '80-150' },
                smc: { sl: '20-40', tp: '50-100' }
            };
            const cfg = configs[strategy];

            const prompt = `You are an expert XAU/USD (Gold) trading analyst. Look at this trading chart carefully.

CONTEXT:
- Instrument: XAU/USD Gold
- Strategy: ${strategy.toUpperCase()}
- Timeframe: ${timeframe.toUpperCase()}
- Session: ${session}
- Stop Loss Range: ${cfg.sl} pips
- Take Profit Range: ${cfg.tp} pips

ANALYZE THE CHART:
1. Read the current price from chart
2. Identify trend direction (bullish/bearish/ranging)
3. Find key support and resistance levels
4. Read any visible indicators (RSI, MACD, EMA, Bollinger Bands, etc.)
5. Identify order blocks, FVG, or other SMC concepts if visible
6. Determine the best trade direction

PROVIDE YOUR ANALYSIS IN THIS EXACT FORMAT:

BIAS: [Strong Buy / Buy / Neutral / Sell / Strong Sell]
CONFIDENCE: [50-95]%
CURRENT_PRICE: [the price you see on chart]
ENTRY: [specific entry price]
STOP_LOSS: [stop loss price]
TAKE_PROFIT: [take profit price]

ANALYSIS:
[Detailed explanation of what you see on the chart: trend, price action, support/resistance, indicator readings, patterns. Explain why you recommend this trade direction.]`;

            // Prepare image for API
            const base64 = uploadedImage.split(',')[1];
            const mimeType = uploadedImage.split(';')[0].split(':')[1];

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'XAU/USD Chart Analysis'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: prompt
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: uploadedImage
                                }
                            }
                        ]
                    }],
                    max_tokens: 1500,
                    temperature: 0.2
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `API Error ${response.status}`);
            }

            const data = await response.json();
            
            if (!data.choices?.[0]?.message?.content) {
                throw new Error('No response from AI');
            }

            return parseResult(data.choices[0].message.content);
        }

        // ============================================
        // PARSE RESULT
        // ============================================
        
        function parseResult(text) {
            console.log('AI Response:', text);

            const get = (key) => {
                const match = text.match(new RegExp(`${key}[:\\s]+(.+?)(?:\\n|$)`, 'i'));
                return match ? match[1].trim() : '';
            };

            const getNum = (key) => {
                const val = get(key).replace(/[^0-9.]/g, '');
                return parseFloat(val) || 0;
            };

            const bias = get('BIAS') || 'Neutral';
            const confidence = parseInt(get('CONFIDENCE')) || 70;
            const currentPrice = getNum('CURRENT_PRICE');
            const entry = getNum('ENTRY') || currentPrice;
            const sl = getNum('STOP_LOSS');
            const tp = getNum('TAKE_PROFIT');
            
            let analysis = text;
            if (text.includes('ANALYSIS:')) {
                analysis = text.split('ANALYSIS:')[1].trim();
            }
            analysis = analysis.substring(0, 1200);

            return { bias, confidence, currentPrice, entry, sl, tp, analysis };
        }

        // ============================================
        // DISPLAY RESULT
        // ============================================
        
        function displayResult(data, strategy, timeframe) {
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('result').classList.add('show');

            document.getElementById('badgeStrategy').textContent = strategy.toUpperCase();
            document.getElementById('badgeTF').textContent = timeframe.toUpperCase();

            const biasEl = document.getElementById('resultBias');
            biasEl.textContent = data.bias;
            biasEl.className = 'signal-bias ' + data.bias.toLowerCase().replace(/\s+/g, '-');

            document.getElementById('confidenceValue').textContent = data.confidence + '%';
            const fill = document.getElementById('confidenceFill');
            fill.style.width = data.confidence + '%';
            fill.className = 'confidence-fill ' + 
                (data.confidence >= 75 ? 'high' : data.confidence >= 50 ? 'medium' : 'low');

            document.getElementById('resultEntry').textContent = data.entry ? '$' + data.entry.toFixed(0) : '--';
            document.getElementById('resultSL').textContent = data.sl ? '$' + data.sl.toFixed(0) : '--';
            document.getElementById('resultTP').textContent = data.tp ? '$' + data.tp.toFixed(0) : '--';

            if (data.entry && data.sl) {
                document.getElementById('slPips').textContent = Math.abs(data.sl - data.entry).toFixed(0) + ' pips';
            }
            if (data.entry && data.tp) {
                document.getElementById('tpPips').textContent = Math.abs(data.tp - data.entry).toFixed(0) + ' pips';
            }

            document.getElementById('resultAnalysis').textContent = data.analysis;
            document.getElementById('resultTime').textContent = 'Analyzed: ' + new Date().toLocaleString();
        }

        // ============================================
        // ERRORS
        // ============================================
        
        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorBox').classList.add('show');
        }

        function hideError() {
            document.getElementById('errorBox').classList.remove('show');
        }
    </script>

</body>
</html>
